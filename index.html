<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Latest compiled and minified CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css">
    
    <title>Mimic Fight Club</title>
    <script src="https://unpkg.com/vue@2.6.14"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    
    <style>
        .multi-select .multi-select-option-list{
            z-index: 8001;
            position:fixed;
            padding: 5vh 5vw;
            box-sizing: border-box;
            background: rgba(0,0,0,0.7);
            top: 0;left:0; right: 0; bottom: 0;
            color:#eee;
            display:flex;
            flex-direction: column;
        }
        .multi-select-option-list .options{
            background:#666;
            overflow-y: auto;
            border-radius: 0 0 5px 5px;
        }
        .multi-select-option{margin: 5px;}
        
        @media only screen and (min-width: 992px) {
            .multi-select > div{
                position:relative;
                z-index: 8001;
            }
            .multi-select .multi-select-option-list .options{
                max-height: 300px;
            }
            .multi-select .multi-select-option-list{
                position:absolute;
                top: 100%;left:0; right: 0; bottom:auto;
                color:#eee;
                padding: 0;
                display:block;
                background: transparent;
            }
        }
        .multi-select .multi-select-option-list.hidden{
            display:none;
        }
        .multi-select .multi-select-option:hover, .multi-select .multi-select-option *:hover{
            cursor:pointer;
        }
        .multi-select-input.form-control{
            overflow-x: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        table.table-dark tbody tr:hover td{
            background-color: #444;
        }
        select.form-select, input.form-control, .multi-select-input.form-control, input.form-control:focus, option, span.input-group-text, .input-group .btn-secondary{
            background-color: #666;
            color: #eee;
            border-color:#444;
        }
        input.form-control:focus{
            background-color: #555;
        }
        span.input-group-text, .input-group .btn-secondary{
            background-color: #444;
        }
        input.form-control::placeholder{ /* Chrome, Firefox, Opera, Safari 10.1+ */
            color: #aaa;
            opacity: 1;
        }
        input.form-control::ms-input-placeholder{ /* Internet Explorer 10-11 */
            color: #aaa;
        }
        input.form-control::-ms-input-placeholder{/* Microsoft Edge */
            color: #aaa;
        }
        .status-button{
            margin-left: 3px;
            margin-right: 3px;
            font: bolder normal normal 16px/1 FontAwesome;
        }
        #external-link-window{
            -webkit-box-shadow: 1px -1px 4px rgba(0,0,0,0.5);
            box-shadow: 1px -1px 4px 0 rgba(0,0,0,0.5);
            position: fixed;
            bottom: 0;
            left: 0;
            width: 520px;
            height: 600px;
            max-height:100vh;
            max-width: 100%;
            z-index:9001;
        }
        #external-link-window iframe{
            width: 500px;
            max-width: 100%;
            height:90%;
            margin: 0 auto;
            display: block;
        }
        #external-link-window .icon-big{
            font-size: 1.6rem;
            align-self: sflex-end;
            padding: 0 5px;
            cursor: pointer;
        }
        [v-cloak] {
            display: none;
        }
        .encounter-trivial{
            color: #2fbd00
        }
        .encounter-low{
            color: #7bbd00
        }
        .encounter-moderate{
            color: #b4bd00
        }
        .encounter-severe{
            color: #bd7e00
        }
        .encounter-extreme{
            color: #bd0900
        }
        .encounter-button:hover{
            border-color: white;
            color: white;
        }
        .encounter-button.encounter-trivial{
            border-color: #2fbd00;
        }
        .encounter-button.encounter-low{
            border-color: #7bbd00;
        }
        .encounter-button.encounter-moderate{
            border-color: #b4bd00;
        }
        .encounter-button.encounter-severe{
            border-color: #bd7e00;
        }
        .encounter-button.encounter-extreme{
            border-color: #bd0900;
        }
        
        .collapsible {
            color: #aaa;
            cursor: pointer;
            padding: 4px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 15px;
        }

        .collapsible:hover {
            background-color: #444;
            color: black;
        }

        .content {
            padding: 0 12px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }

        .content.active{
            margin-top: 10px;
        }

        .creature-input{
            background-color: #666; 
            margin-left:2px; 
            margin-bottom:12px; 
            padding-left:2px; 
            padding-right:2px;
        }
    </style>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GNV4ZBVCVM"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-GNV4ZBVCVM');
    </script>
</head>
<body class="bg-dark text-light">
    <div v-cloak id="app">
        <div v-if="activeLink !== false" id="external-link-window" class="bg-dark">
            <div class="d-flex flex-row-reverse">
                <i class="icon-big bi bi-x-circle" @click="closeLink" style="margin-right:12px;"></i>
                <i @click.prevent="openLinkInPopup(activeLink, $event)" class="icon-big bi bi-box-arrow-up-right"></i>
            </div>
            <iframe align="middle" :src="activeLink" frameborder="0"></iframe>
        </div>
        <div class="container-fluid">
            <div class="row pt-4">
                <div class="col-lg-4">
                    <div class="row">
                        <div class="col-12 col-sm-6">
                            <div class="row">
                                <div class="col-lg-12">
                                    <a href="items.html">Go to the Treasure page</a>
                                </div>
                                <div class="col-lg-12">
                                    <label for="partySizeFilter" class="form-label mb-0">Party size</label>
                                    <select v-model='partyFilters.partySizeFilter' class="form-select" id="partySizeFilter" @change="partySizeOnChange(partyFilters.partySizeFilter)">
                                        <option v-for="size in partySize" :value="size">{{size}} Players</option>
                                    </select>
                                </div>
                                <div class="col-lg-12">
                                    <label for="partyLevelFilter" class="form-label mb-0">Party level</label>
                                    <select v-model='partyFilters.partyLevelFilter' class="form-select" id="partyLevelFilter" @change="partyLevelOnChange(partyFilters.partyLevelFilter)">
                                        <option v-for="level in partyLevel" :value="level">Level {{level}}</option>
                                    </select>
                                </div>
                            </div>
                        </div>  
                        <div class="col-12 col-sm-6 mb-xs-1 mt-xs-1">
                            <div class="ms-auto">
                                <span>Exp budget per difficulty</span>
                            </div>
                            <ul class="list-group-flush ps-0">
                                <li v-for="difficulty in encounterDifficulties" class="d-flex justify-content-between align-items-center">
                                    <div :style="difficulty.isActive ? difficultyStyle : ''"><i :class="'bi-reception-'+difficulty.id+' encounter-'+difficulty.displayName.toLowerCase()" class="bi"></i> {{difficulty.displayName}}</div>
                                    <div :style="difficulty.isActive ? difficultyStyle : ''">{{difficulty.exp}} XP</div>
                                </li>
                            </ul>
                        </div>   
                    </div>
                    <hr style="margin-top: 2px; margin-bottom: 2px;">                  
                    <div class="collapsible">
                        <span>> Show save and load options</span>
                    </div>    
                    <div class="content">   
                        <div class="mt-2 row">
                            <div class="col-8">
                                <input type="text" class="form-control" placeholder="Encounter name" v-model='encounterName'>
                            </div>          
                            <div class="col-4">
                                <button type="button" class="btn btn-primary w-100" v-on:click="saveEncounter" :disabled="encounterName.length === 0 || addedCreatures.length <= 0">Save</button>
                            </div>              
                        </div>
                        <div v-if="encounters.length > 0" class="row mt-2 mr-2">
                            <div class="col-8">
                                <select v-model='selectedEncounterId' class="form-select">
                                    <option value="-1">Select encounter</option>
                                    <option v-for="encounter in encounters" :value="encounter.id">{{encounter.name}}</option>
                                </select>
                            </div>
                            <div class="btn-group col-4" role="group">
                                <button type="button" class="btn btn-primary" v-on:click="loadEncounter" style="margin-right:3px;">Load</button>
                                <button type="button" class="btn btn-danger mr-1" v-on:click="removeEncounter"><i class="bi bi-x"></i></button>
                            </div>
                        </div>
                        <hr>
                    </div>
                    <div class="collapsible">
                        <span>> Show encounter creation options</span>
                    </div>    
                    <div class="content">
                        <div class="ms-auto">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" v-model="isProficiencyWithoutLevel">
                                <label class="form-check-label" for="flexSwitchCheckDefault">Proficiency without Lvl</label>
                            </div>
                        </div>
                        <hr/>
                        <div class="mt-2 mb-2">
                            <div class="mb-2">
                                <span>Use a maximum of </span>
                                <input name="nbOfCreaturesInRandomEncounter" class="col-1 creature-input" type="number" v-model.number='nbOfCreaturesInRandomEncounter'>
                                <span>creatures </span>
                                <br/>
                                <span>The following buttons will create a random encounter for the specified diffuculty based on your filter selection, if it is impossible to reach the difficulty with the available creatures, it will use the closest difficulty</span>
                            </div>
                            <button type="button" class="btn mb-1 bi-reception-0 encounter-trivial encounter-button" v-on:click="createRandomEncounterFromFilters(0)">Trivial</button>
                            <button type="button" class="btn mb-1 bi-reception-1 encounter-low encounter-button" v-on:click="createRandomEncounterFromFilters(1)">Low</button>
                            <button type="button" class="btn mb-1 bi-reception-2 encounter-moderate encounter-button" v-on:click="createRandomEncounterFromFilters(2)">Moderate</button>
                            <button type="button" class="btn mb-1 bi-reception-3 encounter-severe encounter-button" v-on:click="createRandomEncounterFromFilters(3)">Severe</button>
                            <button type="button" class="btn mb-1 bi-reception-4 encounter-extreme encounter-button" v-on:click="createRandomEncounterFromFilters(4)">Extreme</button>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-primary mb-1" v-on:click="addRandomCreatureFromFilters()">Add 1 random creature</button>
                        </div>
                    </div>
                    <hr style="margin-top:4px;">  
                    <div v-if="addedCreatures.length > 0" class="mt-2">
                        <button type="button" class="btn btn-primary mb-1" style="float:right;" v-on:click="resetEncounter">Reset encounter</button>
                    </div>
                    <div class="row">
                        <div class="col-auto">
                            <span>TOTAL XP: {{encounterExp}} XP <b v-if="activeEncounterDifficulty.displayName != ''">(<i :class="'bi-reception-'+activeEncounterDifficulty.id+' encounter-'+activeEncounterDifficulty.displayName.toLowerCase()" class="bi"></i>{{activeEncounterDifficulty.displayName}})</b></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-auto">
                            <span>AWARDED XP PER PLAYER: {{encounterExpFourMan}} XP</span>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-dark">
                            <thead>
                                <tr>
                                    <th class="col">Count</th>
                                    <th class="col">Template</th>
                                    <th class="col">Name</th>
                                    <th class="col">Level</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(creature, index) in encounterCreatures">
                                    <td class="text-nowrap">
                                        <button 
                                        type="button" 
                                        class="btn btn-success btn-sm add-button"
                                        v-bind:value="creature.data.name"
                                        v-on:click="addCreature(creature.data, creature.isWeak, creature.isElite, $event)"><i class="bi bi-plus"></i></button>
                                        <span style="padding-left:5px; padding-right:5px;">{{creature.amount}}</span>                                    
                                        <button 
                                        type="button" 
                                        class="btn btn-secondary btn-sm remove-button"
                                        v-on:click="removeCreature(creature, index, false, $event)"><i class="bi bi-dash"></i></button>
                                        <button 
                                        type="button" 
                                        class="btn btn-danger btn-sm remove-button"
                                        v-on:click="completelyRemoveCreature(creature, index, $event)"><i class="bi bi-x"></i></button>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" :class="creature.isWeak ? 'btn btn-success status-button' : 'btn btn-secondary status-button'" v-on:click="switchWeak(creature, index, $event)"><i class="bi bi-shield-slash"></i></button>
                                            <button type="button" :class="!creature.isWeak && !creature.isElite ? 'btn btn-success status-button' : 'btn btn-secondary status-button'" v-on:click="switchNormal(creature, index, $event)"><i class="bi bi-shield"></i></button>
                                            <button type="button" :class="creature.isElite ? 'btn btn-success status-button' : 'btn btn-secondary status-button'" v-on:click="switchElite(creature, index, $event)"><i class="bi bi-shield-plus"></i></button>
                                        </div>
                                    </td>
                                    <td>
                                        <a v-if="creature.data.link !== ''" :href="getCreatureLink(creature)" @click.prevent.exact="openLink(getCreatureLink(creature), $event)" v-on:click.ctrl.exact="addFilterFromLink([creature.data.name, 'name'])">
                                            <span v-if="creature.isWeak">Weak</span>
                                            <span v-if="creature.isElite">Elite</span>
                                            {{creature.data.name}}
                                        </a>
                                        <template v-else>
                                            <span v-if="creature.isWeak">Weak</span>
                                            <span v-if="creature.isElite">Elite</span>
                                            {{creature.data.name}}
                                        </template>
                                    </td>
                                    <td>
                                        <span v-if="!creature.isWeak && !creature.isElite" v-on:click.ctrl.exact="addFilterFromLink([creature.data.level, 'level'])"> {{creature.data.level}}</span>
                                        <span v-if="creature.isWeak" v-on:click.ctrl.exact="addFilterFromLink([creature.data.level, 'level'])"> {{creature.data.level-1}}</span>
                                        <span v-if="creature.isElite" v-on:click.ctrl.exact="addFilterFromLink([creature.data.level, 'level'])"> {{creature.data.level+1}}</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="row g-1">
                        <div class="order-1 order-md-2 col-8 col-sm-6 col-md-8 align-self-end">
                            <div class="w-100">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search d-md-none"></i> <span class="d-none d-md-inline">Search</span></span>
                                    <input type="text" class="form-control" placeholder="Creature name" v-model='filters.nameFilter'>
                                </div>
                            </div>       
                        </div>                
                        <div class="order-2 oder-sm-1 order-md-1 col-4 col-sm-3 col-md-2">
                            <label for="levelMinFilter" class="form-label">Lvl Min</label>
                            <select v-model='filters.levelMinFilter' class="form-select" id="levelMinFilter">
                                <option v-for="level in levels" :value="level">{{level}}</option>
                            </select>
                        </div>                        
                        <div class="order-2 oder-sm-1 order-md-1 col-4 col-sm-3 col-md-2">
                            <label for="levelMaxFilter" class="form-label">Lvl Max</label>
                            <select v-model='filters.levelMaxFilter' class="form-select" id="levelMaxFilter">
                                <option v-for="level in levels" :value="level">{{level}}</option>
                            </select>
                        </div>
                        <div class="order-2 col-4 col-md-2">
                            <label for="familyFilter" class="form-label">Family</label>
                            <multi-select :options="families" @selected="multiSelectToggle(families, $event)" @closed="closeFilterMultiSelect(families)" name="familyFilter"></multi-select>
                        </div>
                        <div class="order-2 col-4 col-sm col-md-2">
                            <label for="alignmentFilter" class="form-label">Alignment</label>
                            <multi-select :options="alignments" @selected="multiSelectToggle(alignments, $event)" @closed="closeFilterMultiSelect(alignments)"
                                name="alignmentsFilter"></multi-select>
                        </div>                    
                        <div class="order-2 col-4 col-sm">
                            <label for="typeFilter" class="form-label">Type</label>
                            <multi-select :options="types" @selected="multiSelectToggle(types, $event)"
                                @closed="closeFilterMultiSelect(types)" name="typesFilter"></multi-select>
                        </div>                    
                        <div class="order-2 col-4 col-sm">
                            <label for="sizeFilter" class="form-label">Size</label>
                            <multi-select :options="sizes" @selected="multiSelectToggle(sizes, $event)"
                                @closed="closeFilterMultiSelect(sizes)" name="sizesFilter"></multi-select>
                        </div>                    
                        <div class="order-2 col-4 col-sm">
                            <label for="traitFilter" class="form-label">Traits</label>
                            <multi-select :options="traits" @selected="multiSelectToggle(traits, $event)"
                                @closed="closeFilterMultiSelect(traits)" name="traitFilter"></multi-select>
                        </div>
                        <div class="order-2 col-4 col-sm">
                            <label for="sourceFilter" class="form-label">Sources</label>
                            <multi-select :options="sources" @selected="multiSelectToggle(sources, $event)"
                                @closed="closeFilterMultiSelect(sources)" name="sourceFilter"></multi-select>
                        </div>                         
                        <div class="order-1 order-sm-2 col-4 col-sm align-self-end">
                            <button type="button" class="btn btn-primary w-100" v-on:click="resetFilters">Reset filters</button>
                        </div>   
                    </div>
                    <div class="row flex-row-reverse pt-2">
                        <div class="col-auto"><button @click="createCustomCreature" type="button" class="btn btn-primary w-100">Create Custom Creature</button></div>
                    </div>
                    <div class="row">
                        <div class="col table-responsive">
                            <table class="table table-dark">
                                <thead>
                                    <tr>
                                        <th scope="col">Add</th>
                                        <th scope="col">Name</th>
                                        <th scope="col">Level</th>
                                        <th scope="col">Family</th>
                                        <th scope="col">Alignment</th>
                                        <th scope="col">Types</th>
                                        <th scope="col">Size</th>
                                        <th scope="col">Traits</th>
                                        <th scope="col">Source</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(creature, index) in customCreatures">
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-success status-button"
                                                v-on:click="addCreature(creature, true, false, $event)"><i class="bi bi-shield-slash"></i></button>
                                                <button type="button" class="btn btn-success btn-sm status-button"
                                                v-on:click="addCreature(creature, false, false, $event)"><i class="bi bi-shield"></i></button>
                                                <button type="button" class="btn btn-success status-button"
                                                v-on:click="addCreature(creature, false, true, $event)"><i class="bi bi-shield-plus"></i></button>
                                                <button type="button" class="btn btn-danger status-button"
                                                v-on:click="removeCustomCreature(creature, index, $event)"><i class="bi bi-x"></i></button>
                                            </div>
                                        </td>
                                        <td><input type="text" v-model="creature.name" class="form-control"></td>
                                        <td>
                                            <select v-model='creature.level' class="form-select" @change="setEncounterExp">
                                                <option v-for="level in levels" :value="level">{{level}}</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select v-model='creature.family' class="form-select">
                                                <option v-for="family in families" :value="family.value">{{family.displayName}}</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select v-model='creature.alignment' class="form-select">
                                                <option v-for="alignment in alignments" :value="alignment.value">{{alignment.displayName}}</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select v-model='creature.type' class="form-select">
                                                <option v-for="type in types" :value="type.value">{{type.displayName}}</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select v-model='creature.size' class="form-select">
                                                <option v-for="size in sizes" :value="size.value">{{size.displayName}}</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select v-model='creature.traits' class="form-select">
                                                <option v-for="trait in traits" :value="trait.value">{{trait.displayName}}</option>
                                            </select>
                                        </td>
                                        <td><input type="text" v-model="creature.source" class="form-control"></td>
                                    </tr>
                                    <template v-for="creature in filteredCreatureList">
                                        <creature-list-item :creature="creature"
                                            @add-weak="addCreature($event, true, false)"
                                            @add-normal="addCreature($event, false, false)"
                                            @add-elite="addCreature($event, false, true)"
                                            @open-link="openLink($event)"
                                            @add-filter="addFilterFromLink($event)"
                                        />
                                    </template>
                                </tbody>
                            </table>
                            <div>
                                <h4>Tips</h4>
                                <div>Use ctrl+click on column text to auto-filter on that value.</div>
                                <div>While using the filters, use ctrl+enter to unselect all.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src='./monsterTable-2023-07-22.js'></script>
    <script src='./components/creatureListItem.js'></script>
    <script src='./components/multiSelect.js'></script>
    <script>    
        
        function lowerCaseMatch(search, objectKey){
            return (el) => {return el[objectKey].toLowerCase() === search.toLowerCase()};
        };
        
        function sortString(a, b){
            if(a.value < b.value) return -1;
            if(a.value > b.value) return 1;
            return 0;
        }
        
        function setDifficultiesBasedOnNumberOfPlayers(partySize, difficulties){
            difficulties[0].exp = 10*partySize;
            difficulties[1].exp = 15*partySize;
            difficulties[2].exp = 20*partySize;
            difficulties[3].exp = 30*partySize;
            difficulties[4].exp = 40*partySize;
        }
        
        function getCreatureLevel(creature){
            if(creature.isWeak){
                return creature.data.level -1;
            }
            if(creature.isElite){
                return creature.data.level +1;
            }
            return creature.data.level;
        }
        
        var getDefaultFilters = function(){
            return {nameFilter: '', levelMinFilter: 'All', levelMaxFilter: 'All'};
        }       
        var getDefaultEncounterDifficulties = function(){
            return [
            {id: 0, displayName: "Trivial", exp: 40, isActive: false},
            {id: 1, displayName: "Low", exp: 60, isActive: false},
            {id: 2, displayName: "Moderate", exp: 80, isActive: false},
            {id: 3, displayName: "Severe", exp: 120, isActive: false},
            {id: 4, displayName: "Extreme", exp: 160, isActive: false}
            ];
        }
        
        var app = new Vue({
            el: '#app',
            data: {
                customCreatureId: 0,
                customCreatures:[],
                activeLink: false,
                creatureList: creatureList,
                filters: getDefaultFilters(),
                partyFilters: { partySizeFilter: 4, partyLevelFilter: 1},
                alignments: [],
                families: [],
                types: [],
                sizes: [],
                traits: [],
                levels: [],
                sources: [],
                addedCreatures: [],
                partySize: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
                partyLevel: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],
                encounterExp: 0,
                encounterExpFourMan: 0,
                difficultyStyle: "font-weight: bold;",
                encounters: [],
                encounterCounter: 0,
                encounterName: '',
                selectedEncounterId: -1,
                filteredCreatureList: [],
                isAutomaticFilterEnabled: true,
                isProficiencyWithoutLevel: false,
                nbOfCreaturesInRandomEncounter: 4
            },
            computed: {
                alignmentFilter: function(){
                    return this.alignments
                        .filter((el) => {return el.selected === true})
                        .map((el) => {return el.value} );
                },
                familyFilter: function () {
                    return this.families
                        .filter((el) => { return el.selected === true })
                        .map((el) => { return el.value });
                },
                sizeFilter: function () {
                    return this.sizes
                        .filter((el) => { return el.selected === true })
                        .map((el) => { return el.value });
                },
                traitFilter: function () {
                    return this.traits
                        .filter((el) => { return el.selected === true })
                        .map((el) => { return el.value });
                },
                typeFilter: function () {
                    return this.types
                        .filter((el) => { return el.selected === true })
                        .map((el) => { return el.value });
                },
                sourceFilter: function () {
                    return this.sources
                        .filter((el) => { return el.selected === true })
                        .map((el) => { return el.value });
                },
                encounterCreatures: function(){
                    return this.addedCreatures;
                },
                encounterDifficulties: function(){
                    var difficulties = getDefaultEncounterDifficulties();
                    var defaultFilters = getDefaultFilters();
                    setDifficultiesBasedOnNumberOfPlayers(this.partyFilters.partySizeFilter, difficulties);
                    
                    var activeDifficulties = difficulties.filter(diff => {
                        return this.encounterExp >= diff.exp;
                    })
                    if(activeDifficulties.length > 0){
                        var activeDifficulty = activeDifficulties[activeDifficulties.length-1];
                        activeDifficulty.isActive = this.addedCreatures.length > 0;
                    }
                    return difficulties;
                },
                activeEncounterDifficulty: function(){
                    return this.encounterDifficulties.filter(diff => diff.isActive)[0] || {displayName: ""};
                }
            },
            mounted: function(){
                this.creatureList.forEach((creature) => {
                    if(!this.alignments.find(lowerCaseMatch(creature.alignment, "value"))){                        
                        this.alignments.push({displayName:creature.alignment, value:creature.alignment.toLowerCase(), selected: false});
                    }
                });
                this.alignments.sort(sortString);
                
                this.creatureList.forEach((creature) => {
                    let family = creature.family.name;
                    if(!this.families.find(lowerCaseMatch(family, "value"))){                        
                        this.families.push({displayName:family, value:family.toLowerCase(), selected: false});
                    }
                });
                this.families.sort(sortString);
                
                this.creatureList.forEach((creature) => {
                    creature.types.forEach((creatureType) => {
                        let type = creatureType.name;
                        if(!this.types.find(lowerCaseMatch(type, "value"))){                        
                            this.types.push({displayName:type, value:type.toLowerCase(), selected: false});
                        }
                    });    
                });
                this.types.sort(sortString);
                
                this.creatureList.forEach((creature) => {
                    if(!this.sizes.find(lowerCaseMatch(creature.size, "value"))){                        
                        this.sizes.push({displayName:creature.size, value:creature.size.toLowerCase(), selected: false});
                    }
                });
                this.sizes.sort(sortString);
                
                this.creatureList.forEach((creature) => {                    
                    creature.traits.forEach((creatureTrait) => {
                        let trait = creatureTrait.name;
                        if(!this.traits.find(lowerCaseMatch(trait, "value"))){                        
                            this.traits.push({displayName:trait, value:trait.toLowerCase(), selected: false});
                        }
                    });
                });
                this.traits.sort(sortString);
                
                this.creatureList.forEach((creature) => {
                    let source = creature.source.name;
                    if(!this.sources.find(lowerCaseMatch(source, "value"))){                        
                        this.sources.push({displayName:source, value:source.toLowerCase(), selected: false});
                    }
                });
                this.sources.sort(sortString);

                this.creatureList.forEach((creature) => {
                    if(!this.levels.includes(creature.level)){                        
                        this.levels.push(creature.level);
                    }
                });
                this.levels.sort((a,b) => {
                    return a-b;
                });
                this.levels.unshift('All')
                this.filterCreatures();

                this.setInitialValues();                 

                var coll = document.getElementsByClassName("collapsible");
                var i;

                for (i = 0; i < coll.length; i++) {
                    coll[i].addEventListener("click", function() {
                        this.classList.toggle("active");
                        if(this.innerHTML.includes("Show")){
                            this.innerHTML = this.innerHTML.replace("&gt; Show", '<i class="bi bi-arrow-down"></i> Collapse');
                        } else{
                            this.innerHTML = this.innerHTML.replace('<i class="bi bi-arrow-down"></i> Collapse', "&gt; Show");
                        }
                        var content = this.nextElementSibling;
                        content.classList.toggle("active");
                        if (content.style.maxHeight){
                            content.style.maxHeight = null;
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                        }
                    });
                }
            },
            watch:{
                isProficiencyWithoutLevel: function(newValue, oldValue){
                    this.setEncounterExp();
                    window.localStorage.isProficiencyWithoutLevel = JSON.stringify(this.isProficiencyWithoutLevel);
                },
                customCreatures: {
                    handler: function(newCreatures, oldCreatures){
                        this.saveCreatures();
                        var newCreaturesIds = newCreatures.map((creature) => creature.id);
                        var creaturesPresentInEncounter = this.addedCreatures.find((creature) => {
                            return newCreaturesIds.includes(creature.data.id);
                        });
                        if(creaturesPresentInEncounter){
                            this.setEncounterExp();
                        }
                    },
                    deep: true
                },
                addedCreatures: {
                    handler: function(newCreatures, oldCreatures){
                        this.saveCreatures();
                    },
                    deep: true
                },
                filters: {
                    handler: function(newFilters, oldFilters){
                        window.localStorage.filters = JSON.stringify(this.filters);
                    },
                    deep: true
                },
                'filters.nameFilter': function(newValue, oldValue){
                    this.automaticCreatureFilter(true);
                },
                'filters.levelMinFilter': function(){ this.automaticCreatureFilter(); },
                'filters.levelMaxFilter': function(){ this.automaticCreatureFilter(); },
                'filters.familyFilter': function(){ this.automaticCreatureFilter(); },
                'filters.typeFilter': function(){ this.automaticCreatureFilter(); },
                'filters.alignmentFilter': function(){ this.automaticCreatureFilter(); },
                'filters.sizeFilter': function(){ this.automaticCreatureFilter(); },
                'filters.traitFilter': function(){ this.automaticCreatureFilter(); },
                'filters.sourceFilter': function(){ this.automaticCreatureFilter(); },
                encounters: {
                    handler: function(newEncounters, oldEncounters){
                        window.localStorage.encounters = JSON.stringify(this.encounters);
                    }
                }
            },
            created:function(){
                //debounces the filtering for text input
                this.debouncedFilterCreatureList = _.debounce(this.filterCreatures, 200);
                this.automaticCreatureFilter = (debounced = false) => {
                    if(this.isAutomaticFilterEnabled === false) return;
                    if(debounced === true){
                        this.debouncedFilterCreatureList();
                    }else{
                        this.filterCreatures();
                    }
                }
            },
            methods:{
                closeFilterMultiSelect: function(filter){
                    this.filterCreatures();
                    filter.sort((a,b) => {
                        if (a.selected === b.selected ){
                            if (a.value < b.value) return -1;
                            if (a.value > b.value) return 1;
                            return 0;
                        }else if(a.selected === true){
                            return -1;
                        }else{
                            return 1;
                        }
                    });
                },
                multiSelectToggle: function(options, index){
                    this.$set(options[index], 'selected', !options[index].selected);
                },
                addFilterFromLink: function(params){              
                    var filterName = params[0];
                    var filterType = params[1];
                    var filters = [];
                    switch(filterType){
                        case 'family': filters = this.families; break;
                        case 'type': filters = this.types; break;
                        case 'trait': filters = this.traits; break;
                        case 'name': this.updateNameFilter(filterName); return;
                        case 'alignment': filters = this.alignments; break;
                        case 'level': this.updateLevelFilter(filterName); return;
                        case 'size': filters = this.sizes; break;
                        case 'source': filters = this.sources; break;
                    }      
                    var foundFilter = filters.find((filter) => {
                        return filter.displayName == filterName;
                    });
                    this.multiSelectToggle(filters, foundFilter.index);
                    this.closeFilterMultiSelect(filters);
                },
                updateNameFilter: function(name){
                    this.filters.nameFilter = name;
                },
                updateLevelFilter: function(level){
                    this.filters.levelMinFilter = level;
                    this.filters.levelMaxFilter = level;
                },
                addRandomCreatureFromFilters: function(){
                    var index = Math.floor(Math.random() * this.filteredCreatureList.length);

                    this.addCreature(this.filteredCreatureList[index]);
                },
                createRandomEncounterFromFilters: function(difficulty){
                    this.resetEncounter();
                    var maximumNbOfCreatures = this.nbOfCreaturesInRandomEncounter;
                    var levelOfCreaturesToRandomize = [];
                    
                    var expBudget = this.encounterDifficulties[difficulty].exp;
                    var nextEncounterDifficulty = this.encounterDifficulties[difficulty+1];
                    var nextExpBudget = expBudget +1;
                    if(nextEncounterDifficulty){
                        nextExpBudget = nextEncounterDifficulty.exp;
                    }
                    var expMargin = nextExpBudget - expBudget -1;
                    var randomizedPart = Math.floor(Math.random() * expMargin);
                    expBudget += randomizedPart;
                    expMargin -= randomizedPart;

                    for(var i = 0; i < maximumNbOfCreatures && expBudget > 0 && expMargin > 0; i++){
                        var expPerMonster = Math.floor(expBudget / (maximumNbOfCreatures-i));
                        var monsterLevel = this.getBestMonsterLevelForExpBudget(expPerMonster, expMargin);
                        if(monsterLevel){
                            levelOfCreaturesToRandomize.push(monsterLevel);
                        }
                        var budgetForMonsterLevel = monsterLevel ? this.getExpForCreatureLvl(monsterLevel) : 0;
                        expBudget -= budgetForMonsterLevel;
                        if(budgetForMonsterLevel > expPerMonster){
                            expMargin -= budgetForMonsterLevel - expPerMonster;
                            if(expMargin < 0){
                                expMargin = 0;
                            }
                        }
                    }

                    levelOfCreaturesToRandomize.forEach((level) => {
                        this.addCreature(this.getRandomMonsterByLevel(level));
                    });
                },
                getBestMonsterLevelForExpBudget: function(expPerMonster, expMargin){
                    var level = null;
                    var availableCreatureLevels = this.filteredCreatureList.map((creature) => creature.level);
                    var minLevel = Math.min.apply(null, availableCreatureLevels);
                    var maxLevel = Math.max.apply(null, availableCreatureLevels);
                    for(var i = minLevel; i <= maxLevel; i++){
                        var expForMonsterByLevel = this.getExpForCreatureLvl(i);
                        if(expForMonsterByLevel <= expPerMonster){
                            level = i;
                        }
                        else{
                            break;
                        }
                    }
                    if(!level && expMargin > 0){
                        var newMargin = Math.floor(expMargin/2);
                        return this.getBestMonsterLevelForExpBudget(expPerMonster + newMargin, newMargin);
                    }
                    return level;
                },
                getRandomMonsterByLevel: function(level){
                    var creatureListForLevel = this.filteredCreatureList.filter((creature) => {
                        return creature.level == level;
                    });
                    var index = Math.floor(Math.random() * creatureListForLevel.length);
                    return creatureListForLevel[index];
                },
                getExpTable: function(){                    
                    let expTable;
                    if(this.isProficiencyWithoutLevel === false){
                        expTable = [10,15,20,30,40,60,80,120,160];
                    }else{
                        expTable = [9,12,14,18,21,26,32,40,48,60,72,90,108,135,160];
                    }
                    return expTable;
                },                
                getExpForCreatureLvl: function(creatureLevel){
                    var levelDiff = creatureLevel - this.partyFilters.partyLevelFilter;
                    var expValue = 0;

                    var expTable = this.getExpTable();

                    halfTable = Math.floor(expTable.length/2);
                    let expIndex = levelDiff + halfTable;
                    
                    if (expIndex >= expTable.length) {
                        expValue = 300;
                    }else if(expIndex >= 0){
                        expValue = expTable[expIndex];
                    }
                    
                    return expValue;
                },
                filterCreatures: function(){
                    var defaultFilters = getDefaultFilters();
                    var creatures = this.creatureList.filter((creature) => {
                        var isInTheList = true;

                        if (this.filters.levelMinFilter != defaultFilters.levelMinFilter && creature.level < this.filters.levelMinFilter) {
                            isInTheList = false;
                        }
                        if (this.filters.levelMaxFilter != defaultFilters.levelMaxFilter && creature.level > this.filters.levelMaxFilter) {
                            isInTheList = false;
                        }
                        if(this.filters.nameFilter !== "" && !creature.name.toLowerCase().includes(this.filters.nameFilter.toLowerCase())){
                            isInTheList = false;
                        }

                        if (this.alignmentFilter.length > 0 && !this.alignmentFilter.find((el) => {return el === creature.alignment.toLowerCase();})) {
                            isInTheList = false;
                        };
                        if (this.sizeFilter.length > 0 && !this.sizeFilter.find((el) => { return el === creature.size.toLowerCase(); })) {
                            isInTheList = false;
                        };
                        if (this.familyFilter.length > 0 && !this.familyFilter.find((el) => { return el === creature.family.name.toLowerCase(); })) {
                            isInTheList = false;
                        };
                        if (this.typeFilter.length > 0 && !this.typeFilter.find((el) => { return creature.types.find(type => type.name.toLowerCase() === el); })) {
                            isInTheList = false;
                        };
                        if (this.traitFilter.length > 0 && !this.traitFilter.find((el) => { return creature.traits.find(trait => trait.name.toLowerCase() === el); })) {
                            isInTheList = false;
                        };
                        if (this.sourceFilter.length > 0 && !this.sourceFilter.find((el) => { return el === creature.source.name.toLowerCase(); })) {
                            isInTheList = false;
                        };
                       return isInTheList;
                    });
                    this.filteredCreatureList = creatures.sort((a, b) => {
                        if (a.level > b.level) return 1;
                        if (a.level < b.level) return -1;

                        if (a.name > b.name) return 1;
                        if (a.name < b.name) return -1;

                        return 0;
                    });
                },
                createCustomCreature(){
                    this.customCreatureId++;
                    let maxFilter = this.filters.levelMaxFilter;
                    let minFilter = this.filters.levelMinFilter;
                    let level = 1;
                    if(minFilter !== "All" && maxFilter !== "All"){
                        level =  Math.floor((minFilter + maxFilter) / 2);
                    }else if(minFilter !== "All"){
                        level = minFilter;
                    }else if(maxFilter !== "All"){
                        level = maxFilter;
                    }
                    
                    this.customCreatures.push({ 
                        "id": "Custom-" + this.customCreatureId, 
                        "category": "Custom", 
                        "link": "", 
                        "name": "Custom Creature " + this.customCreatureId, 
                        "family": this.filters.familyFilter, 
                        "level": level, 
                        "alignment": this.filters.alignmentFilter, 
                        "type": this.filters.typeFilter, 
                        "size": this.filters.sizeFilter,
                        "traits": this.filters.traitFilter,
                        "sources": this.filters.sourceFilter,
                    });
                },
                openLinkInPopup(link, event){
                    window.open(link);
                },
                closeLink(event){
                    this.activeLink = false;
                },
                openLink(link, event){
                    this.activeLink = link;
                },
                getCreatureLink(creature){                    
                    if(creature.isWeak)
                        return creature.data.link + '&Weak=true';
                    if(creature.isElite)
                        return creature.data.link + '&Elite=true';
                    return creature.data.link;
                },
                resetFilters: function(event){
                    this.isAutomaticFilterEnabled = false;
                    
                    this.filters = getDefaultFilters();
                    this.alignments.map((el) => el.selected = false);
                    this.families.map((el) => el.selected = false);
                    this.types.map((el) => el.selected = false);
                    this.sizes.map((el) => el.selected = false);
                    this.traits.map((el) => el.selected = false);
                    this.sources.map((el) => el.selected = false);
                    
                    this.setMinLevelFilter();
                    this.setMaxLevelFilter();                    

                    this.$nextTick(() => {
                        this.isAutomaticFilterEnabled = true;
                    });
                    this.filterCreatures();
                },
                setMaxLevelFilter: function(){
                    this.filters.levelMaxFilter = this.partyFilters.partyLevelFilter +2;
                    if(this.filters.levelMinFilter > 25){
                        this.filters.levelMinFilter = 25;
                    }
                },
                setMinLevelFilter: function(level){
                    this.filters.levelMinFilter = this.partyFilters.partyLevelFilter -2;
                    if(this.filters.levelMinFilter < -1){
                        this.filters.levelMinFilter = -1;
                    }
                },
                resetEncounter: function(event){
                    this.addedCreatures = [];
                },
                addCreature: function(creatureObject, isWeak, isElite, event){
                    var addedCreature = this.addedCreatures.filter(creature => creature.data.id === creatureObject.id && creature.isElite == isElite && creature.isWeak == isWeak)[0];
                    if(!addedCreature){
                        addedCreature = {data:creatureObject, amount:0, isElite:isElite, isWeak:isWeak};
                        this.addedCreatures.push(addedCreature);
                    }
                    addedCreature.amount++;
                    this.setEncounterExp();
                },
                removeCreature: function(creatureObject, index, fromSwitch, event){
                    this.addedCreatures[index].amount--;
                    if(this.addedCreatures[index].amount < 0 || (this.addedCreatures[index].amount <= 0 && fromSwitch)){
                        this.addedCreatures.splice(index, 1);
                    }                    
                    this.setEncounterExp();
                },
                completelyRemoveCreature: function(creatureObject, index, event){
                    this.addedCreatures.splice(index, 1); 
                    this.setEncounterExp();
                },
                removeCustomCreature: function(creature, index, $event){
                    this.customCreatures.splice(index, 1);
                },
                setEncounterExp: function(){
                    this.encounterExp = 0;
                    
                    this.addedCreatures.forEach(creature => {
                        this.adjustEncounterExpForCreatureLvl(getCreatureLevel(creature), creature.amount);
                    }); 
                    this.encounterExpFourMan = Math.floor((4 / this.partyFilters.partySizeFilter) * this.encounterExp);
                },
                saveCreatures: function(){
                    window.localStorage.addedCreatures = JSON.stringify(this.addedCreatures);
                    window.localStorage.customCreatures = JSON.stringify(this.customCreatures);
                    window.localStorage.customCreatureId = JSON.stringify(this.customCreatureId);
                },
                adjustEncounterExpForCreatureLvl: function(creatureLevel, multiplier){
                    this.encounterExp += this.getExpForCreatureLvl(creatureLevel)*multiplier;
                },
                mergeSameCreature: function(creatureObject, index){
                    var sameCreature = this.addedCreatures.filter(creature => creature != creatureObject && creature.data.id == creatureObject.data.id && creature.isWeak == creatureObject.isWeak && creature.isElite == creatureObject.isElite)[0];
                    if(sameCreature){
                        sameCreature.amount += creatureObject.amount;
                        this.addedCreatures.splice(index, 1);
                    }
                },
                switchWeak: function(creature, index, event){
                    if(creature.isWeak){return;}
                    this.removeCreature(creature.data, index, true);
                    this.addCreature(creature.data, true, false);
                    this.mergeSameCreature(creature, index);
                    this.setEncounterExp();
                },
                switchElite: function(creature, index, event){
                    if(creature.isElite){return;}                    
                    this.removeCreature(creature.data, index, true);
                    this.addCreature(creature.data, false, true);
                    this.mergeSameCreature(creature, index);
                    this.setEncounterExp();
                },
                switchNormal: function(creature, index, event){
                    if(!creature.isWeak && !creature.isElite){return;}
                    this.removeCreature(creature.data, index, true);
                    this.addCreature(creature.data, false, false);
                    this.mergeSameCreature(creature, index);
                    this.setEncounterExp();
                },
                partyLevelOnChange: function(partyLevel){
                    this.setPartyLevel(partyLevel);
                    this.setEncounterExp();
                },
                setPartyLevel: function(partyLevel){
                    window.localStorage.partyLevel = partyLevel;

                    var url = new URL(window.location);
                    if(url.searchParams.has("partyLevel")){
                        url.searchParams.set("partyLevel", partyLevel);
                        window.history.pushState(window.history.state, '', url);
                    }
                },
                partySizeOnChange: function(partySize){
                    this.setPartySize(partySize);
                    this.setEncounterExp();
                },
                setPartySize: function(partySize){
                    window.localStorage.partySize = partySize;

                    var url = new URL(window.location);
                    if(url.searchParams.has("partyLevel")){
                        url.searchParams.set("partySize", partySize);
                        window.history.pushState(window.history.state, '', url);
                    }
                },
                setInitialValues: function(){
                    var url = new URL(window.location);
                    var partyLevel = url.searchParams.get("partyLevel");
                    var partySize = url.searchParams.get("partySize");

                    if(partyLevel == null){
                        partyLevel = window.localStorage.partyLevel;
                    }
                    if(partySize == null){
                        partySize = window.localStorage.partySize;
                    }
                    if(isNaN(partyLevel)){
                        partyLevel = "1";
                    }
                    this.partyFilters.partyLevelFilter = parseInt(partyLevel);
                    if(this.partyFilters.partyLevelFilter < 0){
                        this.partyFilters.partyLevelFilter = 0;
                    }
                    if(this.partyFilters.partyLevelFilter > 20){
                        this.partyFilters.partyLevelFilter = 20;
                    }
                    this.setMinLevelFilter();
                    this.setMaxLevelFilter();

                    if(partySize >= 1 && partySize <= 10){
                        this.partyFilters.partySizeFilter = partySize;
                    }
                    else{
                        this.setPartySize(this.partyFilters.partySizeFilter);
                    }

                    if(window.localStorage.addedCreatures)
                        this.addedCreatures = this.checkCreatureList(JSON.parse(window.localStorage.addedCreatures));
                    if(window.localStorage.customCreatures)
                        this.customCreatures = JSON.parse(window.localStorage.customCreatures);
                    if(window.localStorage.customCreatureId)
                        this.customCreatureId = JSON.parse(window.localStorage.customCreatureId);
                    if(window.localStorage.encounters){
                        this.encounters = JSON.parse(window.localStorage.encounters);
                        this.encounters.forEach((encounter, index) => {
                            encounter.id = index;
                        });
                        this.encounterCounter = this.encounters.length;
                    }
                    if(window.localStorage.isProficiencyWithoutLevel)
                        this.isProficiencyWithoutLevel = JSON.parse(window.localStorage.isProficiencyWithoutLevel);
                    this.setEncounterExp();
                },
                saveEncounter: function(){
                    this.encounters.push({
                        name: this.encounterName, 
                        stringifyCreatures: JSON.stringify(this.addedCreatures),
                        numberOfCreatures: this.addedCreatures.length,
                        id: this.encounterCounter
                    });
                    this.encounterCounter++;
                    this.encounterName = '';
                },
                loadEncounter: function(){
                    var encounter = this.encounters.filter(encounter => encounter.id === this.selectedEncounterId)[0];
                    if(encounter){
                        this.addedCreatures = this.checkCreatureList(JSON.parse(encounter.stringifyCreatures));
                    }
                    this.setEncounterExp();
                },
                checkCreatureList: function(loadedCreatures){
                    var addedCreatures = [];
                    try{
                        if(loadedCreatures.length > 0 && (!loadedCreatures[0].data.name || typeof loadedCreatures[0].data.name === 'object')){
                            loadedCreatures.forEach((loadedCreature) => {
                                var foundCreature = this.creatureList.find((creature) => {
                                    return creature.id == loadedCreature.data.id;
                                });
                                loadedCreature.data = foundCreature;
                                addedCreatures.push(loadedCreature);
                            });
                        }
                        else{
                            addedCreatures = loadedCreatures;
                        }
                    }
                    catch(err){
                        addedCreatures = [];
                    }
                    return addedCreatures;
                },
                removeEncounter: function(){
                    var index = this.encounters.findIndex(encounter => encounter.id === this.selectedEncounterId);
                    if(index != -1){
                        this.encounters.splice(index, 1);
                    }
                    this.selectedEncounterId = -1;
                }
            }
        })
    </script>
    <!-- bootstrap - Latest compiled and minified JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>
</body>
</html>
